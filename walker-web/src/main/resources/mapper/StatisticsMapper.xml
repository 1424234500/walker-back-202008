<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.walker.mapper.StatisticsMapper" >
    <!--/**
    * 多指标  按   接口排名
    * x      y1        y2              y3          y4              y5
    * 接口名  成功次数  成功平均耗时      失败次数      失败平均耗时     成功率0～100
    */
CREATE TABLE `W_LOG_TIME` (
  `ID` varchar(32) NOT NULL DEFAULT '' COMMENT '主键',
  `AVE_COST_NO` varchar(128) DEFAULT '' COMMENT '失败平均耗时',
  `AVE_COST_OK` varchar(1998) DEFAULT '' COMMENT '成功平均耗时',
  `CATE` varchar(256) DEFAULT '1970-01-01 00:00:00' COMMENT '类别',
  `COUNT_NO` varchar(128) DEFAULT '' COMMENT '失败次数',
  `COUNT_OK` varchar(128) DEFAULT '' COMMENT '成功次数',
  `IP_PORT` varchar(128) DEFAULT '' COMMENT '统计服务器ip:port',
  `S_MTIME` varchar(32) DEFAULT '' COMMENT '修改时间',
  `URL` varchar(1998) DEFAULT '' COMMENT '受理接口',
  PRIMARY KEY (`ID`)
) ENGINE=MyISAM DEFAULT CHARSET=utf8
    -->

<!--
| X                            | Y1   | Y2   | Y3   | Y4   | Y5   |
| com.walker.job.JobMakeUser   |   10 |    0 |    0 | NULL |    0 |
| /common/findPage.do          |    2 |    0 |    0 | NULL |    0 |
| com.walker.job.JobUpdateArea |    1 |    0 |    0 | NULL |    0 |
-->
    <select id="findAction" resultType="java.util.Map" >
        select w.URL X
        , w.OK Y1, ifnull(w.COST_OK / w.OK, 0) Y2
        , w.NO Y3,  ifnull(w.COST_NO / w.NO, 0) Y4
        , ifnull(w.OK / (w.OK + w.NO), 0) Y5
        from
            (
                select URL
                , ifnull(sum(COUNT_OK), 0) OK, ifnull(sum(COUNT_NO), 0) NO
                , ifnull(sum(COUNT_OK * AVE_COST_OK), 0) COST_OK, ifnull(sum(COUNT_NO * AVE_COST_NO), 0) COST_NO
                from W_LOG_TIME
                <where>
                    <if test="from != null and from != '' ">
                        and  S_MTIME &gt;= #{from}
                    </if>
                    <if test="to != null and to != '' ">
                        and  S_MTIME &lt;= #{to}
                    </if>
                </where>
                group by URL
            ) w
        order by w.OK desc

    </select>

    <select id="findActionUrl" resultType="java.util.Map" >
        select distinct URL from W_LOG_TIME
        <where>
            <if test="from != null and from != '' ">
                and  S_MTIME &gt;= #{from}
            </if>
            <if test="to != null and to != '' ">
                and  S_MTIME &lt;= #{to}
            </if>
        </where>
        order by URL

    </select>

    <select id="findActionDetail" resultType="java.util.Map" >

        select w.minu X
        , w.OK Y1, ifnull(w.COST_OK / w.OK, 0) Y2
        , w.NO Y3,  ifnull(w.COST_NO / w.NO, 0) Y4
        , ifnull(w.OK / (w.OK + w.NO), 0) Y5
        from
        (
            select SUBSTRING_INDEX(S_MTIME, ':', 2) minu
            , ifnull(sum(COUNT_OK), 0) OK, ifnull(sum(COUNT_NO), 0) NO
            , ifnull(sum(COUNT_OK * AVE_COST_OK), 0) COST_OK, ifnull(sum(COUNT_NO * AVE_COST_NO), 0) COST_NO
            from W_LOG_TIME
            <where>
                <if test="url != null and url != '' ">
                    and  URL = #{url}
                </if>
                <if test="from != null and from != '' ">
                    and  S_MTIME &gt;= #{from}
                </if>
                <if test="to != null and to != '' ">
                    and  S_MTIME &lt;= #{to}
                </if>
            </where>
            group by SUBSTRING_INDEX(S_MTIME, ':', 2)
        ) w
        order by w.minu desc

    </select>

</mapper>